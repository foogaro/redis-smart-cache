:linkattrs:
:project-owner:   redis-field-engineering
:project-name:    redis-sidecar
:project-group:   com.redis
:project-version: 0.1.1
:project-url:     https://github.com/{project-owner}/{project-name}
:product-name:    Redis Smart Cache
:artifact-id:     redis-sidecar-jdbc
:codecov-token:   y0NMn7uIJ0
:grafana-dir:     demo/redis-sidecar-demo/grafana
:icons:           font

++++
<p align="center">
  <img alt="Redis Sidecar" src=".github/images/redis-smart-cache-banner.png">

  <p align="center">
    Redis Smart Cache is a JDBC query cache for <a href='https://redis.io/docs/stack/'>Redis Stack</a>, <a href='https://redis.com/redis-enterprise-cloud/overview/'>Redis Cloud</a>, and <a href='https://redis.com/redis-enterprise-software/overview/'>Redis Enterprise</a>.
  </p>
</p>
++++

'''

image:https://github.com/{project-owner}/{project-name}/actions/workflows/early-access.yml/badge.svg["Build Status", link="https://github.com/{project-owner}/{project-name}/actions/workflows/early-access.yml"]
image:https://img.shields.io/maven-central/v/{project-group}/{artifact-id}[Download, link="https://search.maven.org/#search|ga|1|{artifact-id}"]
image:https://codecov.io/gh/{project-owner}/{project-name}/branch/master/graph/badge.svg?token={codecov-token}["Coverage", link="https://codecov.io/gh/{project-owner}/{project-name}"]

{product-name} lets you add caching to your application without changing the code.

Implemented as a wrapper around your backend database's JDBC driver, {product-name} can cache
slow, repeated queries from Redis, bypassing expensive database calls and greatly
improving response times.

== Table of Contents

* <<Background>>
* <<Quick start>>
* <<Installation>>
* <<Usage>>
* <<Support>>
* <<License>>

== Background

Redis is an in-memory data store designed to serve data with the fastest possible response times.
For this reason, Redis is frequently used for caching.

It's not always easy to modify your code to utilize Redis as a cache.
You need to think about a number of issues, including:

* Result set serialization and deserialization
* Fault-tolerance
* Cache invalidation

This is why we built {product-name}.
After adding a single dependency and setting some basic configuration, your JDBC application can take advantage of Redis as a cache without any changes to your code.

== Quick start

To understand how {product-name} works, it's best to try it for yourself.

This example showcases an application that continuously performs queries against a MySQL database and uses {product-name} to cache query results.

First, clone this git repository:
[source,console,subs="verbatim,attributes"]
----
git clone {project-url}.git
cd {project-name}
----

Next, use Docker Compose to launch containers for MySQL, Grafana, Redis Stack, and {product-name} example app instance:
[source,console]
----
docker-compose up
----

Once all of these containers have started, log in to Grafana by pointing your browser to http://localhost:3000.
Use the following credentials:

Username: `admin`
Password: `admin`

In the Grafana UI, click http://localhost:3000/datasources/new?utm_source=grafana_gettingstarted[Add your first datasource].

In the filter box, enter `Redis` and click on the first entry (*Redis datasource*).

In the wizard that shows up, enter `redis://redis:6379` for the Redis address and click `Save & test`.

image::{grafana-dir}/redis-datasource.png[Redis Datasource,width=600]

Now import the demo dashboard by clicking `Dashboards/Import` in the sidebar.

image::{grafana-dir}/import-dashboard.png[Import Dashboard,width=300]

Next, click `Upload JSON file` and upload `{project-name}/demo/redis-sidecar-demo/grafana/dashboard.json`.

At the bottom of the page, select the Redis datasource that you just created and click `Import`.

You should see the following dashboard:

image::{grafana-dir}/dashboard.png[Dashboard,width=600]

After a few minutes, the Redis cache will be populated, yielding dramatically improved response times.

== Installation

To use {product-name} with an existing application, you'll need to add the {product-name} JDBC driver as an application dependency.

.Maven
[source,xml,subs="verbatim,attributes"]
----
<dependency>
    <groupId>{project-group}</groupId>
    <artifactId>{artifact-id}</artifactId>
    <version>{project-version}</version>
</dependency>
----

.Gradle
[source,groovy,subs="verbatim,attributes"]
----
dependencies {
    implementation '{project-group}:{artifact-id}:{project-version}'
}
----

The next step is to configure {product-name}, as described below.

== Usage

First, ensure that your application is using {product-name} as its JDBC driver:

`com.redis.sidecar.SidecarDriver`

Next, set your JDBC URI to the URI of your Redis instance prefixed by `jdbc:`.
For example `jdbc:redis://cache.redis.cloud:6379`

See https://github.com/lettuce-io/lettuce-core/wiki/Redis-URI-and-connection-details#uri-syntax[Lettuce's URI syntax] for all of the possible URI parameters you can use here.

Next step is providing bootstrap configuration. 

=== Bootstrap Configuration

Bootstrap configuration contains the information {product-name} needs to connect to Redis and the backend database and is specified using the following JDBC properties:

==== Backend database

===== `sidecar.driver.class-name`
Class name of the backend database JDBC driver (*required*)

===== `sidecar.driver.url`
JDBC URL for the backend database (*required*). You can also include any property your backend JDBC driver requires, like `username` or `password`. These will be passed to the backend JDBC driver as is.

==== Redis
To further configure how {product-name} connects to Redis, set the following properties:

===== `sidecar.redis.cluster`
Set to `true` for Redis Cluster connections (default: `false`).

===== `sidecar.redis.tls`
Establish a secure TLS connection.

===== `sidecar.redis.tls-verify`
TLS verification mode: `NONE` (default) no verification at all, `CA` verify the CA and certificate without verifying that the hostname matches, `FULL` full certificate verification.

===== `sidecar.redis.username`
Authenticate using the provided username. Overrides username in Redis URI. Requires password.

===== `sidecar.redis.password`
Authenticate using the provided password. Overrides password in Redis URI.

===== `sidecar.redis.keyspace`
Prefix for all Redis keys used by Sidecar, such as cache entries, configuration, and metrics. (default: `sidecar`)

===== `sidecar.redis.key-separator`
Delimiter to use between key elements (default: `:`).

===== `sidecar.redis.pool.max-active`
Maximum number of connections that can be allocated by the pool at a given time (default: `8`). Use a negative value for no limit.

===== `sidecar.redis.pool.max-idle`
Maximum number of "idle" connections in the pool (default: `8`). Use a negative value to indicate an unlimited number of idle connections.

===== `sidecar.redis.pool.min-idle`
Target for the minimum number of idle connections to maintain in the pool (default: `0`). This setting only has an effect if both it and time between eviction runs are positive.

===== `sidecar.redis.pool.max-wait`
Maximum amount of time in milliseconds a connection allocation should block before throwing an exception when the pool is exhausted (default: `-1`). Use a negative value to block indefinitely.

===== `sidecar.redis.pool.time-between-eviction-runs`
Time in milliseconds between runs of the idle object evictor thread (default: `-1`).
When positive, the idle object evictor thread starts; otherwise no idle object eviction is performed.

===== `sidecar.redis.codec-buffer-size`
Maximum capacity, in MB, of the buffer used to encode a result set (default: `100`).

==== Additional components

===== `sidecar.metrics-step`
Metrics publishing interval in seconds (default: `60`)

[[config_step]]
===== `sidecar.config-step`
Rule config refresh interval in seconds (default: `10`)

=== Rules
{product-name} uses rules to determine how SQL queries are cached.
Rule configuration is stored in a Redis JSON document located at the key `sidecar:config` and can be modified at runtime.
{product-name} will dynamically update to reflect changes made to the JSON document (see <<config_step>> above to change the refresh rate). 

Here is the default rule configuration:
[source,json]
----
{
  "rules": [
    {
      "tables": null,
      "tablesAny": null,
      "tablesAll": null,
      "regex": null,
      "ttl": 3600
    }
  ]
}
----

Rules are processed in order and consist of *criteria* (conditions) and *actions* (results). Only the first rule with matching criteria will be considered, and its action applied.

==== Criteria

===== `tables`
Triggers if the given tables are exactly the same as the list in the SQL query (order does not matter).

==== `tablesAny`
Triggers if any of the given tables shows up in the SQL query.

==== `tablesAll`
Triggers if all the given tables show up in the SQL query.

==== `regex`
Triggers if regular expression matches the SQL query.

==== Action

===== `ttl`
Sets the time-to-live (in seconds) for the corresponding cache entry (default: `3600`).
Use `0` for no caching, `-1` for no expiration.

==== Examples

===== `SELECT * FROM customer, product, order` 
[cols="6a,^1"]
|==========================
|
[source,json]
----
{ "tables": ["order", "product"] }
----
|icon:close[role=red]
|
[source,json]
----
{ "tables": ["order", "product", "customer"] }
----
|icon:check[role=green]
|
[source,json]
----
{ "tablesAny": ["transaction"] }
----
|icon:close[role=red]
|
[source,json]
----
{ "tablesAny": ["transaction", "order"] }
----
|icon:check[role=green]
|
[source,json]
----
{ "tablesAll": ["transaction", "order", "product"] }
----
|icon:close[role=red]
|
[source,json]
----
{ "tablesAll": ["order", "product"] }
----
|icon:check[role=green]
|
[source,json]
----
{ "regex": "SELECT \* FROM trans.*" }
----
|icon:close[role=red]
|
[source,json]
----
{ "regex": "SELECT \* FROM cust.*" }
----
|icon:check[role=green]
|==========================

== Support

{product-name} is supported by Redis, Inc. on a good faith effort basis.
To report bugs, request features, or receive assistance, please {project-url}/issues[file an issue].

== License

{product-name} is licensed under the MIT License. Copyright (C) 2023 Redis, Inc.
